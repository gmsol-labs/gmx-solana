import {
  apply_factor,
  create_orders,
  Market,
  MarketGraph,
  Position,
  Pubkey,
} from "../../pkg/index.js";

function toBase64(data: number[]): string {
  const uint8 = new Uint8Array(data);

  const binary = String.fromCharCode(...uint8);

  return btoa(binary);
}

// Apply factor.
const result = apply_factor(123n, 90_000_000_000_000_000_000n);
console.log("apply factor:", result);

const encodedMarket =
  "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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMCwAAAAAAACevCWgAAAAAqfQPaAAAAAAnrwloAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAsAAAAAAABgAgAAAAAAAEcuf5oaAAAAIoCjkwwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMCwAAAAAAAAAAAAAAAAAADAsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACuvDRxGgAAAAAAAAAAAAAA1sNPiAwAAAAAAAAAAAAAAAwLAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAATJJGAQAAAAAAAAAAAAAAAAkc1AoAAAAAAAAAAAAAAAAMCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJRqCAQAAAAAAAAAAAAAAADujHgAAAAAAAAAAAAAAAAA9goAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHpRnL1cd/YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcLAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOz8t0Ro549XBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAD2CgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANkf07IAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABHoD2mBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcLAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAXhWbVwUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOtcwl11/wOZAAAAAAAAAACO5RJB67OeBQAAAAAAAAAABwsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcGbgrXzkbAAAAAAAAAAAAB8/apW4PAQAAAAAAAAAAAAcLAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIH4OIspTAgAAAAAAAAAAAGxTYsxxnQAAAAAAAAAAAAAHCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlcjRrfSEoAAAAAAAAAAAAUg9gi7xwCAAAAAAAAAAAABwsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADSmGcixqOCAAAAAAAAAAAAwdANektoAAAAAAAAAAAAAPYKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAV7LmBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAK7BFBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADcdVUojGlqIxsAAAAAAAAAQxmB1Rg8rXYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwLAAAAAAAAJ68JaAAAAACp9A9oAAAAACevCWgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMCwAAAAAAAGACAAAAAAAARy5/mhoAAAAigKOTDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";

const encodedPosition =
  "qryP5HpA99AAAKonnS1zO8jxwBSrN6JWJCEcqXbLGZ7GLqJ5zd5Y9p41AQAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMKhMtqEXwT4SYzrEExJSClgE9XJbT3T05sgeb6VBv6xBpuIV/6rgYT7aH9jRhjANdrEOdwa6ztVmKDwAAAAAAEBAAAAAAAAAAIAAAAAAAAABAAAAAAAAAADAAAAAAAAAABe0LIAAAAAAAAAAAAAAAAAKd4HAAAAAAAAAAAAAAAAAADQafqNC/LzAAAAAAAAAAAATDG42aeYAAAAAAAAAAAAAEvkKAAbAAAAAAAAAAAAAACC3+QNRwAAAAAAAAAAAACg8AOnvQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";

const supply = 79185141665179n;

// Decode Market from base64 data.
const market = Market.decode_from_base64(encodedMarket);
const model = market.to_model(supply);
const prices = {
  index_token: {
    min: 1560019900000n,
    max: 1561071800000n,
  },
  long_token: {
    min: 14776017000000n,
    max: 14778132000000n,
  },
  short_token: {
    min: 99989200000000n,
    max: 100004200000000n,
  },
};

// Calculate market token price.
const price = model.market_token_price({
  prices,
  maximize: true,
  pnl_factor: "max_after_deposit",
});
console.log("market token price:", price);

// Calculate market status.
console.log("market status:", model.status({ prices }));

// Create a MarketGraph.
const graph = new MarketGraph({
  swap_estimation_params: {
    value: 1_000_000_000_000_000_000_000n,
    base_cost: 1_000_000_000_000_000_000n,
  },
  max_steps: 5,
});

// Insert market from base64 data.
graph.insert_market_from_base64(encodedMarket, supply);

console.log(graph.market_tokens().map((token) => token.toString()));

const gmx = "GmxDsqjKYUrwgbvccGrpF1LoyHPUq8FQqT1FJfkvrMfY";
const wsol = "So11111111111111111111111111111111111111112";
const usdc = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v";

graph.update_token_price(gmx, { ...prices.index_token });
graph.update_token_price(wsol, { ...prices.long_token });
graph.update_token_price(usdc, { ...prices.short_token });

// Calculate best swap path.
const { path } = graph.best_swap_path(
  "So11111111111111111111111111111111111111112",
  "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
  false
);
console.log(path.map((token) => new Pubkey(token).toString()));

// Create order.
const marketToken = "BwN2FWixP5JyKjJNyD1YcRKN1XhgvFtnzrPrkfyb4DkW";
const transactions = create_orders(
  "MarketIncrease",
  [
    {
      market_token: marketToken,
      is_long: true,
      size: 100_000_000_000_000_000_000_000n,
      amount: 10_000_000n,
    },
  ],
  {
    recent_blockhash: "3KarAamyLd6dFFmMsh79fXjrdAWp5DB6dxF3BgLK3SuM",
    payer: "11111111111111111111111111111112",
    collateral_or_swap_out_token: wsol,
    hints: new Map([
      [
        marketToken,
        {
          long_token: wsol,
          short_token: usdc,
        },
      ],
    ]),
    transaction_group: {
      compute_unit_price_micro_lamports: 2000000,
    },
  }
);

for (const batch of transactions.serialize()) {
  for (const txn of batch) {
    console.log(toBase64(txn));
  }
}

// Decode position from base64 data.
const position = Position.decode_from_base64(encodedPosition);
const positionModel = position.to_model(model);
console.log("size:", positionModel.size());
console.log("size_in_tokens:", positionModel.size_in_tokens());
console.log("collateral amount:", positionModel.collateral_amount());
console.log("status:", positionModel.status(prices));
